<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-help-name="http request">
    <p>發送 HTTP 請求並回傳結果。</p>

    <h3>輸入</h3>
    <dl class="message-properties">
        <dt class="optional">url <span class="property-type">字串</span></dt>
        <dd>如果未在節點中設定，則此屬性可動態設定請求的 URL。</dd>
        <dt class="optional">method <span class="property-type">字串</span></dt>
        <dd>如果未在節點中設定，則此屬性可動態設定請求的 HTTP 方法。必須是<code>GET</code>、<code>PUT</code>、<code>POST</code>、<code>PATCH</code>或<code>DELETE</code>之一。</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>設定請求的HTTP 標頭。</dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>如果設定，則可用於發送帶有 cookie 的請求。</dd>
        <dt class="optional">payload</dt>
        <dd>請求的 Body 內容。</dd>
        <dt class="optional">rejectUnauthorized</dt>
        <dd>如果設定爲<code>false</code>，則允許對使用 Self-signed 證書的 HTTPS 伺服器進行請求。</dd>
        <dt class="optional">followRedirects</dt>
        <dd>如果設定爲<code>false</code>，則不允許轉址（HTTP 301）。預設情況下爲<code>true</code></dd>
        <dt class="optional">requestTimeout</dt>
        <dd>如果設定爲正數毫秒，將覆蓋全域設定的<code>httpRequestTimeout</code>參數。</dd>
    </dl>
    <h3>輸出</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">字串 | object | buffer</span></dt>
        <dd>Response 的 Body 內容。可以設定爲以字串形式回傳 Body 內容、嘗試當作 JSON 字串來解析或將其保留爲二進位 buffer。</dd>
        <dt>statusCode <span class="property-type">數值</span></dt>
        <dd>Response 的狀態碼，如果請求無法完成，則回應錯誤狀態碼。</dd>
        <dt>headers <span class="property-type">object</span></dt>
        <dd>包含 Response 標頭的物件。</dd>
        <dt>responseUrl <span class="property-type">字串</span></dt>
        <dd>如果在處理請求時發生任何重定向，則此屬性爲最終重定向的 URL。否則則爲原始請求的 URL。</dd>
        <dt>responseCookies <span class="property-type">object</span></dt>
        <dd>如果 Response 包含cookie，則此屬性是每個 cookie 的鍵值對（Key-Value pair）的物件。</dd>
        <dt>redirectList <span class="property-type">陣列</span></dt>
        <dd>如果請求被重定向了一次或多次，則相關資訊將累積並被保存在此屬性。「location」是下一個重定向目標。cookie 是從重定向來源所回傳的cookie。</dd>
    </dl>
    <h3>詳細</h3>
	<p>當節點在設定時，URL 屬性可以包含<a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache樣式</a>標簽。這些標簽允許代入<code>msg</code>的值到 URL 之中。例如，如果url設定爲<code>example.com/{{{{topic}}}</code>，它將自動代入<code>msg.topic</code>的值。使用{{{...}}}可以防止 mustache 轉義「/&」等字元。</p>
    <p>節點可以自動將輸入的<code>msg.payload</code>轉換爲 GET 請求所需的 query string，在這種情況下，<code>msg.payload</code> 必須是一個物件。</p>
    <p><b>注意：</b>如果使用了連線代理，則應設定 <code>http_proxy=...</code> 環境變數並重新啓動 Node-RED，或使用「代理設定」。如果設定了代理設定，則設定優先於環境變數。</p>
    <h4>使用多個 HTTP Request 節點</h4>
    <p>爲了在一個流程中多次使用此節點，必須要注意<code>msg.headers</code>屬性的處理。依據節點訊息傳遞的邏輯來看，理論上在第一個節點會在得到回應後而設定此標頭屬性，所以將訊息傳遞下去後，下一個節點的 Request 標頭中會直接繼承使用此屬性。而這往往不是我們所期望的行為，所以此節點在設計上有一些額外設計，如果節點之間的<code>msg.headers</code>屬性保持不變，則第二個節點將忽略它以避免誤用第一個節點的 Response 標頭。由於有這樣的設計，若想要在這種情況下自定義標題，首先應刪除或替換<code>msg.headers</code>的物件，或將其重置爲全新的空物件：<code>{}</code>。</p>
    <h4>Cookie 處理</h4>
    <p>輸入給節點的<code>cookies</code>屬性必須是鍵值對（Key-Value pair）的物件。該值可以是設定 cookie 值的字串，也可以是具有單個<code>value</code>屬性的物件。</p>
    <p>請求所回傳的所有 cookie 都將保存在<code>responseCookies</code>屬性裡。</p>
    <h4>內容類型處理</h4>
    <p>如果輸入的<code>msg.payload</code>是一個物件，則節點將自動將請求的內容類型設定爲<code>application/json</code>並對其進行編碼。</p>
    <p>若要將請求編碼爲 form 數據，應將<code>msg.headers[“content-type”]</code>設定爲<code>application/x-www-form-urlencoded</code>。</p>
    <h4>文件上傳</h4>
    <p>要執行檔案上傳的動作，應將<code>msg.headers["content-type"]</code>設定爲<code>multipart/form-data</code>和<code>msg.payload</code>輸入給節點的必須是具有以下結構的物件：</p>
    <pre><code>{
    "KEY": {
        "value": FILE_CONTENTS,
        "options": {
            "filename": "FILENAME"
        }
    }
}</code></pre>
    <p><code>KEY</code>,<code>FILE_CONTENTS</code>和<code>FILENAME</code>的值應設定爲適當的值。</p>
    
</script>
