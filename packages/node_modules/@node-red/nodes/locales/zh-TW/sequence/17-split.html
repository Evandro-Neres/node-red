<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-help-name="split">
    <p>將一則訊息拆分爲多則訊息。</p>

    <h3>輸入</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | 字串 | 陣列 | buffer</span></dt>
        <dd>節點的行爲由 <code>msg.payload</code> 的類型決定:
            <ul>
                <li><b>字串</b>/<b>buffer</b> - 使用指定的字符（預設值：<code>\n</code>），依照獨立的陣列元素或固定陣列的長度將訊息拆分。</li>
                <li><b>陣列</b> - 訊息將被拆分爲單個陣列元素或固定長度的陣列。</li>
                <li><b>object</b> - 將爲物件的每個鍵/值對（Key-Value pair）發送一則訊息。</li>
            </ul>
        </dd>
    </dl>
    <h3>輸出</h3>
    <dl class="message-properties">
        <dt>parts<span class="property-type">object</span></dt>
        <dd>此屬性包含有關如何從原始訊息拆分的資訊。如果傳遞給 <b>join</b> 節點，則可以將這些訊息序列重組爲單個訊息。此屬性具有以下子屬性：
        <ul>
            <li><code>id</code> - 一組訊息的識別 ID</li>
            <li><code>index</code> - 群組中的索引位置</li>
            <li><code>count</code> - 如果已知群組中的訊息總數。請參閱下面的「串流模式」</li>
            <li><code>type</code> - 訊息的類型 - 字串/陣列/物件/buffer</li>
            <li><code>ch</code> - 對於字串或 buffer，用於將訊息拆分爲字串或 Bytes 陣列的資料</li>
            <li><code>key</code> - 為了此物件建立專屬的 Key。可以將節點設定爲也將此值複製到另一個訊息屬性，例如：<code>msg.topic</code>。</li>
            <li><code>len</code> - 使用固定長度值拆分訊息時，每段訊息的長度</li>
        </ul>
        </dd>
    </dl>
    <h3>詳細</h3>
    <p>在使用 <b>join</b> 節點將訊息序列重新組合爲單個訊息之前，推薦使用此節點來輕鬆地建立訊息序列。</p>
    <p>此節點使用 <code>msg.parts</code> 屬性跟蹤序列的各個部分。</p>
    <h4>流媒體模式</h4>
    <p>此節點還可以用於重新編排訊息串流。例如，序列裝置（Serial device）可能會在一則訊息內，發送換行終止（newline-terminated）命令，並在其訊息尾端帶有部分命令。在「串流模式」下，此節點將會適當拆分一則訊息並確保每個訊息內容段落都是完整的。如果末尾有部分內容片段，則該節點將保留該片段，並將其添加到下一則所收到的訊息之前。</p>
    <p>在此模式下運行時，此節點將不會設置 <code>msg.parts.count</code> 屬性，因爲串流中期望的訊息數總是未知的，這意味著它不能在自動模式下與 <b>join</b> 節點一起使用。</p>
</script>

<script type="text/x-red" data-help-name="join">
    <p>將訊息序列合併成一則訊息。</p>
    <p>共有三種模式：</p>
    <dl>
        <dt>自動模式</dt>
        <dd>與 <b>split</b> 節點搭配使用時，它將自動將已被拆分的訊息進行合併。</dd>
        <dt>手動模式</dt>
        <dd>手動地以各種方式合併訊息序列。</dd>
        <dt>Reduce 模式</dt>
        <dd>使用表達式來逐步簡化和聚合所有訊息成為單一訊息。</dd>
    </dl>
    <h3>輸入</h3>
    <dl class="message-properties">
        <dt class="optional">parts<span class="property-type">object</span></dt>
        <dd>使用自動模式時，所有的訊息都應包含此屬性。<b>split</b> 節點會生成此屬性，但也可以手動進行設置。該屬性具有以下屬性：
        <ul>
            <li><code>id</code> - 一組訊息的識別 ID</li>
            <li><code>index</code> - 群組中的索引位置</li>
            <li><code>count</code> - 如果已知群組中的訊息總數。請參閱下面的「串流模式」</li>
            <li><code>type</code> - 訊息的類型 - 字串/陣列/物件/buffer</li>
            <li><code>ch</code> - 對於字串或 buffer，用於將訊息拆分爲字串或 Bytes 陣列的資料</li>
            <li><code>key</code> - 為了此物件建立專屬的 Key。可以將節點設定爲也將此值複製到另一個訊息屬性，例如：<code>msg.topic</code>。</li>
            <li><code>len</code> - 使用固定長度值拆分訊息時，每段訊息的長度</li>
        </ul>
        </dd>
        <dt class="optional">complete</dt>
        <dd>如果此屬性被設定，則節點將當前訊息內容附加到 payload 上，並以當下狀態發送並輸出訊息。</dd>
    </dl>
    <h3>詳細</h3>

    <h4>自動模式</h4>
    <p>自動模式使用輸入訊息的 <code>parts</code> 屬性來決定應如何合併訊息序列。這使它可以自動反向進行 <b>split</b> 節點的操作。</p>

    <h4>手動模式</h4>
    <p>設置爲以手動模式時，此節點能以各種不同的方法來處理訊息：</p>
    <ul>
        <li><b>字串</b>或<b>buffer</b> - 選擇每則訊息內的屬性，並在內容與內容之間以指定的字元或 buffer 來合併。</li>
        <li><b>陣列</b> - 將選擇的屬性或整個訊息合併輸出成陣列</li>
        <li><b>鍵/值對物件</b> - 使用每個訊息的屬性，來決定被需要值的鍵。</li>
        <li><b>合併物件</b> - 將每個訊息的屬性合併到一個物件下。</li>
    </ul>
    <p>輸出訊息的其他屬性都取自輸出結果前的最後一則訊息。</p>
    <p>可以用<i>計數</i>來確定應接收多少條訊息來進行合併。對於物件輸出，可以設定爲達到指定數量後的每則訊息都發送一則輸出。</p>
    <p>可以用<i>超時</i>來設定輸出新訊息之前的等待時間。</p>
    <p>如果收到 <code>msg.complete</code> 屬性被設定的訊息，輸出訊息並重置訊息數量計數。</p>
    <p>如果收到 <code>msg.reset</code> 屬性被設定的訊息，則部分收到的訊息將被刪除而不會被輸出，同時重置訊息數量計數。</p>

    <h4>Reduce 模式</h4>
    <p>選擇 Reduce 模式時，將套用表達式來合併每則輸入的訊息內容，並聚合成一則訊息。</p>

    <dl class="message-properties">
        <dt>初始值</dt>
        <dd>累積值的初始值(<code>$A</code>)。</dd>
        <dt>Reduce 表達式</dt>
        <dd>序列中的每則訊息所使用的 JSONata 表達式。其結果將作爲累加值傳遞到表達式的下一個調用。在表達式中，可以使用以下特殊變數：
            <ul>
                <li><code>$A</code>: 累計值 </li>
                <li><code>$I</code>: 訊息在序列中的索引</li>
                <li><code>$N</code>: 序列中的訊息數量</li>
            </ul>
        </dd>
        <dt>最終調整式子</dt>
        <dd>可選的 JSONata 表達式，在將 Reduce 表達式應用於序列中的所有訊息之後應用。在表達式中，可以使用以下特殊變數：
            <ul>
                <li><code>$A</code>: 累計值</li>
                <li><code>$N</code>: 訊息在序列中的索引</li>
            </ul>
        </dd>
        <p>預設情況下，按順序從序列的第一則訊息到最後一則訊息套用 Reduce 表達式。也可以選擇以相反的順序套用 Reduce 表達式。</p>
    </dl>
    <p><b>例子：</b>給定一系列數字值，以下設置將計算平均值：
        <ul>
            <li><b>Reduce 表達式</b>: <code>$A+payload</code></li>
            <li><b>初始值</b>: <code>0</code></li>
            <li><b>最終調整式</b>: <code>$A/$N</code></li>
        </ul>
    </p>
    <h4>儲存訊息</h4>
    <p>該節點將在內部暫存訊息，以便跨序列工作。運行時設定 <code>nodeMessageBufferMaxLength</code> 可用於設定暫存的訊息數量。</p>
</script>
